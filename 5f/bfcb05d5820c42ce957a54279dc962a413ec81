---------------------------------------------------------------------------

by nicolas-grekas at 2016-03-31T16:44:43Z

note that the VarDumper component has similar logic that should be patched also

---------------------------------------------------------------------------

by stof at 2016-03-31T17:17:06Z

> Do you you consider a bug not having colors on Windows?

not a bugfix IMO (especially given that we can already force it with a CLI flag)

---------------------------------------------------------------------------

by mlocati at 2016-04-01T14:00:38Z

> AFAIK, PHP_WINDOWS_VERSION_MAJOR goves the version of Windows where PHP was compiled, not the version where it runs

No, it's not true. They are [determined at runtime](https://github.com/php/php-src/blob/c72282a13b12b7e572469eba7a7ce593d900a8a2/main/main.c#L2144-L2146).

I diggered *a bit* into these `PHP_WINDOWS_VERSION_...` constants, and the results are quite interesting.

I tested exactly the same PHP executables under these different PCs:

- Windows 7
  version 6.1 32 bit (build 7601 SP 1)
  output of standard `ver` command in Windows Command Prompt: 6.1.7601
- Windows 8
  version 6.2 32 bit (build 9200)
  output of standard `ver` command in Windows Command Prompt: 6.2.9200
- Windows 8.1
  version 6.3 32 bit (build 9600)
  output of standard `ver` command in Windows Command Prompt: 6.3.9600
- Windows 10
  version 1511 64 bit (build 10586.164)
  output of standard `ver` command in Windows Command Prompt: 10.0.10586

And here's the values of the three constants (concatenated with dots for simplicity) for every PHP version and every PC:

| PHP Version | Windows 7 | Windows 8 | Windows 8.1 | Windows 10 |
| --- | --- | --- | --- | --- |
| 5.3.0 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.1 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.2 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.3 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.4 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.5 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.6 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.7 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.8 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.9 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.10 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.11 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.12 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.13 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.14 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.15 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.16 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.17 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.18 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.19 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.20 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.21 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.22 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.23 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.24 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.25 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.26 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.27 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.28 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.3.29 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.0 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.1 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.2 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.3 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.4 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.5 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.6 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.7 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.8 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.9 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.10 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.11 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.12 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.13 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.14 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.15 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.16 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.17 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.18 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.19 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.20 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.21 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.22 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.23 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.24 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.25 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.26 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.27 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.28 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.29 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.30 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.31 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.32 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.33 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.34 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.35 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.36 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.37 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.38 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.39 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.40 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.41 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.42 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.43 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.44 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.4.45 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.0 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.1 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.2 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.3 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.4 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.5 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.6 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.7 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.8 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.9 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.10 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.11 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.12 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.13 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.14 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.15 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.16 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.17 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.18 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.19 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.20 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.21 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.22 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.23 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.24 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.25 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.26 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.5.27 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.5.28 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.5.29 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.5.30 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.5.31 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.5.32 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.5.33 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.5.34 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.0 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.1 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.2 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.3 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.4 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.5 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.6 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.7 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.8 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.9 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.10 | 6.1.7601 | 6.2.9200 | 6.2.9200 | 6.2.9200 |
| 5.6.11 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.12 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.13 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.14 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.15 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.16 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.17 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.18 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.19 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 5.6.20 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 7.0.0 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 7.0.1 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 7.0.2 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 7.0.3 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 7.0.4 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |
| 7.0.5 | 6.1.7601 | 6.2.9200 | 6.3.9600 | 10.0.10586 |

--

For these versions:
- PHP 5.4
- PHP 5.5 up to 5.5.26
- PHP 5.6 up to 5.6.10

the detected Windows version is wrong because of [this Windows change](https://msdn.microsoft.com/en-us/library/windows/desktop/dn302074(v=vs.85).aspx).

--

These versions:
- PHP 5.5 from 5.5.27
- PHP 5.6 from 5.6.11
- PHP 7.0

have [this patch](https://github.com/php/php-src/commit/7e731e4d9dc5b15774d9e046e683d4af04721a40), so those versions have a reliable value for the constants.

--

Given all that, I think that this pull request is still valid, but it will work only for PHP 5.5 >= 5.5.27, PHP 5.6 >= 5.6.11 and PHP 7+ (older versions will continue to work as before).

So, @stof, shall I reopen this PR?

---------------------------------------------------------------------------

by mlocati at 2016-04-01T14:12:55Z

PS: a more reliable way to determine the exact Windows version would be to use `exec('ver')`, but:
- we should check if `exec` can be used (like [here](https://github.com/concrete5/concrete5/blob/c4efb9c64c50c2e0940233718d9dd5a65448e55f/web/concrete/src/File/Service/Zip.php#L103-L107))
- the output of `ver` is localized, so we'd need to use a regex to catch its result

---------------------------------------------------------------------------

by stof at 2016-04-01T14:37:12Z

it is fine if the autodetection works fine only in uptodate PHP versions. Not detecting color support won't break the console (it will just fallback to non colored output by default)

---------------------------------------------------------------------------

by mlocati at 2016-04-01T15:30:53Z

I updated this PR, adding the Windows 10 detection code to `DeprecationErrorHandler` and `CliDumper` too

---------------------------------------------------------------------------

by nicolas-grekas at 2016-04-03T17:27:04Z

:+1:, as a bug fix on 2.3 to me...

---------------------------------------------------------------------------

by fabpot at 2016-04-03T17:41:47Z

I don't think it qualifies as a bug fix (and this PR does not apply cleanly on 2.3 as two files did not exist back then). For such a PR, I propose to merge it on master and be done with it.
