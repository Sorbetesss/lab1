---------------------------------------------------------------------------

by xabbuh at 2018-04-02T09:11:57Z

This PR is based on the changes for the `3.4` branch from #26739 which needs to be merged first. The relevant changes are in the second commit.
